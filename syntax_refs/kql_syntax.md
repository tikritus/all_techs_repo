# Kusto Query Language (KQL) Cheat Sheet for Cybersecurity Investigations

This cheat sheet provides a quick reference to common Kusto Query Language (KQL) components used in Azure Data Explorer, Azure Monitor Logs (Log Analytics), Microsoft Sentinel, and other services for cybersecurity analysis.

**Note:**
* Table names (`SecurityEvent`, `SigninLogs`, `Syslog`, `AzureActivity`) and column names (`Account`, `EventID`, `Computer`, `SourceIP`, `CommandLine`) are examples and will vary based on your data sources and schemas.
* KQL is case-sensitive for table names, column names, operators, and functions.

| Component Type         | KQL Component / Operator | Description                                                                                                | Example Usage (KQL)                                                                                                                                                              |
|------------------------|--------------------------|------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Core Querying** | (Table Name)             | Starts a query by specifying the table to query from.                                                      | `SecurityEvent`                                                                                                                                                                    |
|                        | `find`                   | Searches across multiple tables and columns for a specific value or predicate.                             | `find in (SecurityEvent, Syslog) where Computer == "Server01" and EventID == 4625`                                                                                                 |
|                        | `search`                 | Searches across all or specified tables and columns for a free-text keyword or structured predicate.       | `search "failed login" or (EventID == 4625 and AccountType == "User")`                                                                                                             |
| **Filtering** | `where`                  | Filters rows based on a predicate (boolean condition).                                                     | `SecurityEvent \| where EventID == 4625 and Account contains "admin"`                                                                                                              |
|                        | `in`                     | Checks if a value is present in a list of values.                                                          | `SecurityEvent \| where EventID in (4625, 4720, 4740)`                                                                                                                             |
|                        | `!in`                    | Checks if a value is not present in a list of values.                                                      | `SigninLogs \| where AppDisplayName !in ("Office365 Shell WCSS-Client", "Azure Portal")`                                                                                           |
|                        | `has`                    | Case-insensitive string match (substring).                                                                 | `Syslog \| where ProcessName has "powershell"`                                                                                                                                     |
|                        | `!has`                   | Case-insensitive string does not contain (substring).                                                      | `SecurityEvent \| where CommandLine !has "mimikatz"`                                                                                                                               |
|                        | `contains`               | Case-sensitive string match (substring).                                                                   | `AuditLogs \| where OperationName contains "Create"`                                                                                                                               |
|                        | `!contains`              | Case-sensitive string does not contain (substring).                                                        | `AppServiceHTTPLogs \| where UserAgent !contains "Bot"`                                                                                                                            |
|                        | `startswith`             | Checks if a string starts with a specified prefix (case-sensitive).                                        | `AzureActivity \| where Caller IpAddress startswith "192.168."`                                                                                                                    |
|                        | `endswith`               | Checks if a string ends with a specified suffix (case-sensitive).                                          | `SecurityEvent \| where TargetUserName endswith "$"`                                                                                                                                 |
|                        | `matches regex`          | Matches a string against a regular expression.                                                             | `Syslog \| where Message matches regex @"failed login for user (\w+)" `                                                                                                            |
|                        | `isnull()`               | Checks if a value is null.                                                                                 | `SigninLogs \| where isempty(DeviceDetail.operatingSystem)`                                                                                                                        |
|                        | `isnotnull()` / `not(isnull())` | Checks if a value is not null.                                                                         | `SecurityEvent \| where isnotnull(WorkstationName)`                                                                                                                                |
|                        | `isempty()`              | Checks if a string or dynamic value is empty.                                                              | `SigninLogs \| where isempty(ConditionalAccessPolicies)`                                                                                                                           |
|                        | `isnotempty()`           | Checks if a string or dynamic value is not empty.                                                          | `SecurityAlert \| where isnotempty(Entities)`                                                                                                                                      |
| **Time Filtering** | `ago()`                  | References a time relative to now (e.g., `ago(1h)`, `ago(7d)`).                                            | `SecurityEvent \| where TimeGenerated > ago(24h)`                                                                                                                                  |
|                        | `between`                | Filters data within a specified time range.                                                                | `SigninLogs \| where TimeGenerated between (datetime(2023-10-01) .. datetime(2023-10-07))`                                                                                          |
| **Projection & Selection** | `project`              | Selects specific columns to include, rename, or compute new columns.                                     | `SecurityEvent \| project TimeGenerated, Computer, Account, EventID, Activity`                                                                                                     |
|                        | `project-away`           | Specifies columns to exclude from the output.                                                              | `SigninLogs \| project-away TenantId, Id, Type`                                                                                                                                    |
|                        | `extend`                 | Computes new columns and appends them to the existing ones.                                                | `SecurityEvent \| extend TargetDomainName = tostring(split(TargetUserName, "\\\\")[0]), TargetUser = tostring(split(TargetUserName, "\\\\")[1])`                               |
| **Aggregation & Grouping** | `summarize`            | Groups rows that have the same values in specified columns and computes aggregate functions.             | `SecurityEvent \| summarize count() by EventID, AccountType` <br> `SigninLogs \| summarize dcount(UserPrincipalName) by AppDisplayName`                                             |
|   Aggregate Functions  | `count()`                | Counts the number of rows.                                                                                 | `SecurityEvent \| summarize TotalEvents = count() by Computer`                                                                                                                     |
|                        | `dcount(column)`         | Estimates the distinct count of values in a column.                                                        | `SigninLogs \| summarize UniqueUsers = dcount(UserPrincipalName) by AuthenticationRequirement`                                                                                     |
|                        | `sum(column)`            | Sums the values in a numeric column.                                                                       | `NetworkMonitoring \| summarize TotalBytes = sum(BytesTransferred) by SourceIP, DestinationIP`                                                                                     |
|                        | `avg(column)`            | Calculates the average of values in a numeric column.                                                      | `PerformanceCounters \| summarize AvgCPU = avg(CounterValue) where CounterName == "% Processor Time"`                                                                              |
|                        | `min(column)`            | Finds the minimum value in a column.                                                                       | `Heartbeat \| summarize FirstHeartbeat = min(TimeGenerated) by Computer`                                                                                                           |
|                        | `max(column)`            | Finds the maximum value in a column.                                                                       | `Heartbeat \| summarize LastHeartbeat = max(TimeGenerated) by Computer`                                                                                                            |
|                        | `arg_min(expr, *)`       | Finds the row with the minimum value of `expr` and returns all columns (`*`) or specified columns.       | `SecurityEvent \| summarize arg_min(TimeGenerated, *) by Account` (gets the first login event for each account)                                                                    |
|                        | `arg_max(expr, *)`       | Finds the row with the maximum value of `expr` and returns all columns (`*`) or specified columns.       | `SecurityEvent \| summarize arg_max(TimeGenerated, *) by Account` (gets the last login event for each account)                                                                     |
|                        | `make_list(column)`      | Creates a dynamic array of all values of a column in the group.                                            | `SigninLogs \| summarize IPAddresses = make_list(IPAddress) by UserPrincipalName`                                                                                                  |
|                        | `make_set(column)`       | Creates a dynamic array of unique values of a column in the group.                                         | `SecurityEvent \| summarize TargetComputers = make_set(Computer) by Account`                                                                                                       |
| **Sorting Results** | `order by` / `sort by`   | Sorts rows by one or more columns in ascending (`asc`) or descending (`desc`) order.                       | `SecurityEvent \| order by TimeGenerated desc, Account asc`                                                                                                                        |
| **Limiting Results** | `top` / `limit`          | Returns the first N rows. `top` is often used with `order by`.                                             | `SecurityEvent \| top 100 by TimeGenerated desc`                                                                                                                                   |
| **Joining Tables** | `join`                   | Merges rows of two tables based on a common column. (Kinds: `inner`, `leftouter`, `rightouter`, `fullouter`). | `SecurityEvent \| where EventID == 4624 \| join kind=inner (SigninLogs on $left.Account == $right.UserPrincipalName and $left.TimeGenerated == $right.TimeGenerated)`               |
| **Unioning Tables** | `union`                  | Combines the result sets of two or more tables.                                                            | `union SecurityEvent, Syslog, AuditLogs \| where TimeGenerated > ago(1h)`                                                                                                          |
| **String Functions** | `strlen()`               | Returns the length of a string.                                                                            | `SecurityEvent \| extend CommandLineLength = strlen(CommandLine)`                                                                                                                  |
|                        | `tolower()`, `toupper()` | Converts a string to lowercase or uppercase.                                                               | `SigninLogs \| extend LowercaseApp = tolower(AppDisplayName)`                                                                                                                      |
|                        | `substring()`            | Extracts a substring.                                                                                      | `AzureActivity \| extend Operation = substring(OperationName, indexof(OperationName, "/") + 1)`                                                                                    |
|                        | `replace()`              | Replaces all occurrences of a specified regex with another string.                                         | `Syslog \| extend CleanMessage = replace(@"-{2,}", "-", Message)`                                                                                                                   |
|                        | `split()`                | Splits a string by a delimiter into an array of strings.                                                   | `SecurityEvent \| extend PathParts = split(FilePath, "\\\\")`                                                                                                                      |
|                        | `extract()`              | Extracts a substring matching a regex capture group.                                                       | `Syslog \| extend UserFromMessage = extract(@"user=(\w+)", 1, Message)`                                                                                                            |
|                        | `parse_json()` / `todynamic()` | Parses a string as a JSON value.                                                                         | `AuditLogs \| extend PropertiesObject = todynamic(Properties)`                                                                                                                     |
| **Dynamic/Array Functions** | `mv-expand`            | Expands a multi-value array or property bag into multiple rows.                                            | `SigninLogs \| mv-expand todynamic(ConditionalAccessPolicies)`                                                                                                                     |
|                        | `array_length()`         | Returns the length of a dynamic array.                                                                     | `OfficeActivity \| extend RecipientCount = array_length(Recipient)`                                                                                                                |
| **Let Statements (Variables)** | `let`                | Defines a variable or a dynamic function.                                                                  | `let suspiciousIPs = datatable(IP:string)["1.2.3.4", "5.6.7.8"]; SigninLogs \| where IPAddress in (suspiciousIPs)`                                                                  |
| **Comments** | `//`                     | Single-line comment.                                                                                       | `// Search for failed administrative logons` <br> `SecurityEvent \| where EventID == 4625 and Account endswith "admin"`                                                              |

This cheat sheet provides a solid foundation for using KQL in cybersecurity investigations. The power of KQL comes from combining these operators and functions to build complex queries. Always refer to the official Microsoft documentation for the most detailed and up-to-date information.
